---
title: "Scientific programming Assignment2"
output: html_document
author: Daphne Leunissen
date: 5 October 2018
---
## R Markdown

This is an R Markdown document of assignment 2 Making multivariate statistics reproducible. 

### Loading packages
The first step is installing and loading packages. 
``` {r packages}

# installing packages
#install.packages("pls")
#install.packages("caret")

# load package
library(rcdklibs)
library(pls)
library(caret)

```

### Import data
Next I need to set my working directory and import the datatable as well as the descriptors file.
```{r setup}

# set working directory
setwd("C:\\Users\\daphn\\OneDrive\\Documenten\\Master Systems Biology\\Scientific programming\\assignment2\\")

# import data
data.raw <- read.csv("AID_624202_datatable2.txt", sep="\t", header = T, row.names = 1)

# import descriptors
descriptors <- read.csv("descriptors.txt", sep="\t", header = T, row.names = 1)

```

### Preprocessing data
The columns that contain only zeros/NA values will be removed. Also the other NA values will be removed.
``` {r preprocessing}
# remove columns full of NA values
descriptors1 <- descriptors[, colSums(descriptors != 0, na.rm = TRUE) > 0]

# remove columns with a variance near zero using the nearZeroVar function (caret package)
novar.col <- nearZeroVar(descriptors1)
descriptors2   <- descriptors1[, -novar.col]

```

### Combining descriptor file with activity score
The molSIDs from the descriptors file are matches with the PUBCHEM_SID in the datatable file. After which the activity score will be extracted from the datatable file and added to the descriptors file. 
``` {r activity score}
# match SIDs
row.numbers <- as.data.frame(match(descriptors2[,1], data.raw[,1]))
colnames(row.numbers) <- "matching row numbers"

#extract activity score of these row numbers
activity.score <- as.data.frame(data.raw[row.numbers[,1], 4])
colnames(activity.score) <- "Activity_score"

# add activity score to descriptors matrix
descriptors3 <- cbind(descriptors2, activity.score)

``` 

### Dividing the data
Divide the data in training and test set, 80% and 20% respectively  
``` {r processing}
# randomly select 80% of the data to be part of the training set and use the rest of the sample for the test set

set.seed(123)

smp_size <- floor(0.80 * nrow(descriptors3))
train.ind <- sample(nrow(descriptors3), size = smp_size)
train.set <- descriptors3[train.ind, ]
test.set <- descriptors3[-train.ind, ]

``` 

### Scaling the data
The data will be scaled using the scale function.
``` {r normalization}
# scaling without the activity score column?
train.set1 <- train.set[,-247]
test.set1 <- test.set[,-247]
# scaling without the molSIDs column?
train.set2 <- train.set1[,-1]
test.set2 <- test.set1[,-1]

train.norm <- as.data.frame(scale(train.set2), center = TRUE, scale = TRUE)
#train.norm <- preProcess(train.set, method=c("center", "scale"))
test.norm <- as.data.frame(scale(test.set2), center = TRUE, scale = TRUE)

``` 

Perform variable selection ?

### Partial Least Squares
To model the data Partial least squares is performed using the pls function.
``` {r model prediction}

# prediction model with crossvalidation included
pred.model <- plsr(Activity_score ~ . , data=train.norm, validation = "CV")      
summary(pred.model)

# Prediction 
pls.train <- as.data.frame(predict(pred.model, ncomp = 10, newdata = train.norm))
summary(pls.train)
pls.test <- as.data.frame(predict(pred.model, ncomp = 10, newdata = test.norm))
summary(pls.test)

# save observed and predicted scores of test set together (easier for the plot)
results <- cbind(test.score, pls.test)
colnames(results)[1] <- "Observed"
colnames(results)[2] <- "Predicted"
# plot the results obtained from prediction model vs the actual activity scores
ggplot(results, aes(x=Observed, y=Predicted)) + geom_point(size=2, shape=17) +
ggtitle("Predicted vs observed (test set) activity score")

``` 

### Crossvalidation
Tuning the model using the caret package.
``` {r crossvalidation}
set.seed(12)  
# save max number of components
max.comp <- 10

# 10 fold cross validation
cv <- trainControl(method = "cv",number=10)
# Tuning a pls model 
pls.cv <- train(train.norm, train.score$Activity_score,
                 method = "pls",
                 tuneLength = max.comp,
                 trControl = cv)
# plot the model
plot(pls.cv)

# prediction with test set
pls.test1 <- as.data.frame(predict(pls.cv, test.norm))

``` 

### Including Plots
Scatter plot of model predictions (PUBCHEM_ACTIVITY_SCORE vs experimental value).
